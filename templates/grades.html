{% extends 'base.html' %}

{% block title %}Grades Tracker{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4" style="font-weight: 700;">
    <i class="bi bi-bar-chart-fill text-dark"></i> Grades Tracker
  </h2>

  <form method="POST" class="row g-3 mb-4">
    <div class="col-md-2">
      <input name="unit" class="form-control" placeholder="e.g. MATH1700" required>
    </div>
    <div class="col-md-2">
      <input name="assessment" class="form-control" placeholder="e.g. Midsem" required>
    </div>
    <div class="col-md-2">
      <input name="score" class="form-control" type="number" step="0.01" placeholder="Score" required>
    </div>
    <div class="col-md-2">
      <input name="out_of" class="form-control" type="number" step="0.01" placeholder="Out Of" required>
    </div>
    <div class="col-md-2">
      <input name="weight" class="form-control" type="number" step="0.01" placeholder="Weight (%)" required>
    </div>
    <div class="col-md-2 d-grid">
      <button class="btn btn-primary">Add Grade</button>
    </div>
  </form>

  <h4 class="mb-3"><i class="bi bi-brain text-danger"></i> Grade Summary</h4>
  <div class="table-responsive mb-4">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Unit</th>
          <th>Assessment</th>
          <th>Score</th>
          <th>Weight (%)</th>
          <th>Contribution (%)</th>
        </tr>
      </thead>
      <tbody>
        {% for grade in grades %}
        <tr>
          <td>{{ grade.unit }}</td>
          <td>{{ grade.assessment }}</td>
          <td>{{ grade.score }}/{{ grade.out_of }}</td>
          <td>{{ grade.weight }}%</td>
          <td>{{ grade.contribution }}%</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% for unit, summary in summaries.items() %}
  <div class="alert alert-info fw-semibold text-center">
    <span class="text-primary">{{ unit }}:</span>
    Achieved: <strong>{{ "%.1f" | format(summary.achieved) }}%</strong>
    â€” Required to Pass: <strong>{{ "%.1f" | format(50 - summary.achieved) }}%</strong>
  </div>

  <div class="d-flex justify-content-center mb-5">
    <div style="width: 45%;">
      <canvas id="chart-{{ unit }}"></canvas>
    </div>
  </div>
  {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const chartData = {{ chart_data|tojson }};
  for (const unit in chartData) {
    const ctx = document.getElementById(`chart-${unit}`);
    if (!ctx) continue;
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: chartData[unit].labels,
        datasets: [{
          label: 'Contribution (%)',
          data: chartData[unit].values,
          backgroundColor: ['#d6b3ff', '#e2c7ff', '#f3e0ff', '#f0e6ff']
        }]
      },
      options: {
        plugins: {
          title: {
            display: true,
            text: `Contribution Breakdown for ${unit}`,
            font: { size: 16 },
            color: '#333'
          }
        },
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }
</script>
{% endblock %}
